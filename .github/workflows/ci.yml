name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'  # 毎週月曜 03:00 UTC (日本時間 12:00)

jobs:
  build-and-test:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release -DENABLE_WERROR=ON

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

      - name: Include Count Check
        run: bash scripts/check-include-counts.sh

      - name: Structural KPI Summary
        if: always()
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          cd build
          ctest -V -R tst_structural_kpi 2>&1 | tee kpi-output.txt

          # Extract KPI values to JSON
          bash ../scripts/extract-kpi-json.sh kpi-output.txt kpi-results.json
          cat kpi-results.json

          # Build Step Summary
          echo "## Structural KPI Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if grep -q "FAILED" kpi-output.txt; then
            echo ":x: **KPI violations detected**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            grep -E "(FAIL|violation|limit|lines)" kpi-output.txt >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          else
            echo ":white_check_mark: All structural KPIs within limits" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          # KPI values table
          echo "### KPI Values" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value | Limit |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|------:|------:|" >> "$GITHUB_STEP_SUMMARY"
          grep -oP 'KPI:\s+\K.*' kpi-output.txt | while IFS= read -r line; do
            key=$(echo "$line" | sed -E 's/\s+=\s+.*//')
            value=$(echo "$line" | sed -E 's/.*=\s+([0-9]+).*/\1/')
            limit=$(echo "$line" | sed -nE 's/.*\(limit:\s+([0-9]+)\).*/\1/p')
            echo "| $key | $value | ${limit:--} |" >> "$GITHUB_STEP_SUMMARY"
          done
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if grep -q "FAILED" kpi-output.txt; then
            exit 1
          fi

      - name: Upload KPI Artifact
        if: always()
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f  # v7.0.0
        with:
          name: structural-kpi-${{ github.sha }}
          path: build/kpi-results.json
          retention-days: 90

      - name: KPI Diff Report
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BASE_REF="${{ github.base_ref }}"

          # Find latest successful run on base branch
          RUN_ID=$(gh run list \
            --workflow ci.yml \
            --branch "$BASE_REF" \
            --status success \
            --limit 1 \
            --json databaseId \
            --jq '.[0].databaseId // empty')

          if [ -z "$RUN_ID" ]; then
            echo "### KPI Diff (base → PR)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> Skipped: no successful CI run found on \`$BASE_REF\`." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Download KPI artifact from base branch run
          mkdir -p base-kpi
          gh run download "$RUN_ID" -p "structural-kpi-*" -D base-kpi/ 2>/dev/null || {
            echo "### KPI Diff (base → PR)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> Skipped: KPI artifact not found in base branch run." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          }

          # Find the downloaded JSON (artifact unpacks into subdirectory)
          BASE_KPI=$(find base-kpi -name "kpi-results.json" -type f | head -1)

          if [ -z "$BASE_KPI" ]; then
            echo "### KPI Diff (base → PR)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "> Skipped: kpi-results.json not found in downloaded artifact." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Generate diff report
          python3 scripts/kpi-diff.py "$BASE_KPI" build/kpi-results.json >> "$GITHUB_STEP_SUMMARY"

      - name: Layer Dependency Check
        if: always()
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          cd build
          ctest -V -R tst_layer_dependencies 2>&1 | tee layer-deps-output.txt

          echo "## Layer Dependency Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if grep -q "FAILED" layer-deps-output.txt; then
            echo ":x: **Layer dependency violations found**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            grep -E '\[src/.*forbidden includes:|includes ".*\(forbidden' layer-deps-output.txt \
              | sed 's/^[0-9]*: //' >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo ":white_check_mark: No layer dependency violations" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"

  build-debug:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure (Debug)
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug -DENABLE_WERROR=ON

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

  static-analysis:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Install clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-tidy

      - name: Configure with clang-tidy
        run: cmake -B build -S . -DENABLE_CLANG_TIDY=ON -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON

      - name: Build and check
        run: |
          cmake --build build --parallel 2 2>&1 | tee build.log
          if grep -q "warning:.*\[-clang" build.log; then
            echo "::error::clang-tidy warnings detected"
            grep "warning:.*\[-clang" build.log
            exit 1
          fi

  clazy:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    env:
      CLAZY_CHECKS: "level0,level1"
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Install clazy
        run: sudo apt-get update && sudo apt-get install -y clazy

      - name: Configure
        run: cmake -B build -S . -DCMAKE_CXX_COMPILER=clazy -DCMAKE_BUILD_TYPE=Release

      - name: Build with clazy
        run: cmake --build build --parallel 2 2>&1 | tee clazy-output.txt

      - name: Check for warnings
        run: |
          if grep -q "\-Wclazy-" clazy-output.txt; then
            echo "::error::clazy warnings found"
            grep "\-Wclazy-" clazy-output.txt
            exit 1
          fi

  sanitize:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      contains(github.event.pull_request.labels.*.name, 'sanitize')
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure with Sanitizers
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test with Sanitizers
        env:
          QT_QPA_PLATFORM: offscreen
          ASAN_OPTIONS: "detect_leaks=0:halt_on_error=1"
          UBSAN_OPTIONS: "halt_on_error=1:print_stacktrace=1"
        run: cd build && ctest --output-on-failure

  sanitize-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure with Sanitizers
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build --parallel 2

      - name: Run core tests with sanitizers
        env:
          QT_QPA_PLATFORM: offscreen
          ASAN_OPTIONS: "detect_leaks=0:halt_on_error=1"
          UBSAN_OPTIONS: "halt_on_error=1:print_stacktrace=1"
        run: |
          cd build
          ctest -R "tst_shogiboard|tst_shogimove|tst_shogiutils|tst_movevalidator|tst_coredatastructures|tst_usiprotocolhandler|tst_csaprotocol|tst_kifconverter|tst_ki2converter|tst_csaconverter|tst_jkfconverter|tst_usiconverter|tst_usenconverter|tst_wiring_" \
            --output-on-failure --timeout 120

  coverage:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Install gcovr
        run: pip install gcovr

      - name: Configure with Coverage
        run: |
          cmake -B build -S . -DBUILD_TESTING=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

      - name: Generate Coverage Report
        run: |
          gcovr --root src --object-directory build \
            --xml build/coverage.xml \
            --html-details build/coverage.html \
            --print-summary | tee build/coverage-summary.txt

      - name: Coverage Summary
        run: |
          echo "## Code Coverage" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat build/coverage-summary.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
        with:
          files: build/coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload Coverage Report
        uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f  # v7.0.0
        with:
          name: coverage-report
          path: |
            build/coverage.xml
            build/coverage.html*
            build/coverage-summary.txt

  build-macos:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel 3

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: ctest --test-dir build --output-on-failure

  build-windows:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Install Qt6
        uses: jurplel/install-qt-action@d325aaf2a8baeeda41ad0b5d39f84a6af9bcf005  # v4.3.0
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: ctest --test-dir build --config Release --output-on-failure

  translation-check:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: Translation Sync Check
        if: github.event_name == 'pull_request'
        run: bash scripts/check-translation-sync.sh origin/${{ github.base_ref }}

      - name: Check translation regression
        run: |
          baseline_file="resources/translations/baseline-unfinished.txt"
          failed=false
          echo "## Translation Status" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| File | Actual | Baseline | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-------:|---------:|--------|" >> "$GITHUB_STEP_SUMMARY"
          while IFS=: read -r file expected; do
            actual=$(grep -c 'type="unfinished"' "resources/translations/$file" || true)
            if [ "$actual" -gt "$expected" ]; then
              echo "| $file | $actual | $expected | :x: regression |" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Translation regression in $file: $actual > $expected (baseline)"
              failed=true
            elif [ "$actual" -lt "$expected" ]; then
              echo "| $file | $actual | $expected | :warning: improved |" >> "$GITHUB_STEP_SUMMARY"
              echo "::warning::Translation improved in $file: $actual < $expected. Update baseline!"
            else
              echo "| $file | $actual | $expected | :white_check_mark: |" >> "$GITHUB_STEP_SUMMARY"
            fi
          done < "$baseline_file"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "$failed" = true ]; then exit 1; fi
