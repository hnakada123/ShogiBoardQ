name: CI

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'  # 毎週月曜 03:00 UTC (日本時間 12:00)

jobs:
  build-and-test:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

      - name: Structural KPI Summary
        if: always()
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          cd build
          ctest -V -R tst_structural_kpi 2>&1 | tee kpi-output.txt

          # Extract KPI values to JSON
          bash ../scripts/extract-kpi-json.sh kpi-output.txt kpi-results.json
          cat kpi-results.json

          # Build Step Summary
          echo "## Structural KPI Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if grep -q "FAILED" kpi-output.txt; then
            echo ":x: **KPI violations detected**" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            grep -E "(FAIL|violation|limit|lines)" kpi-output.txt >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          else
            echo ":white_check_mark: All structural KPIs within limits" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
          fi

          # KPI values table
          echo "### KPI Values" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value | Limit |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|------:|------:|" >> "$GITHUB_STEP_SUMMARY"
          grep -oP 'KPI:\s+\K.*' kpi-output.txt | while IFS= read -r line; do
            key=$(echo "$line" | sed -E 's/\s+=\s+.*//')
            value=$(echo "$line" | sed -E 's/.*=\s+([0-9]+).*/\1/')
            limit=$(echo "$line" | sed -nE 's/.*\(limit:\s+([0-9]+)\).*/\1/p')
            echo "| $key | $value | ${limit:--} |" >> "$GITHUB_STEP_SUMMARY"
          done
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if grep -q "FAILED" kpi-output.txt; then
            exit 1
          fi

      - name: Upload KPI Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structural-kpi-${{ github.sha }}
          path: build/kpi-results.json
          retention-days: 90

  build-debug:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure (Debug)
        run: cmake -B build -S . -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

  static-analysis:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Install clang-tidy
        run: sudo apt-get update && sudo apt-get install -y clang-tidy

      - name: Configure with clang-tidy
        run: cmake -B build -S . -DENABLE_CLANG_TIDY=ON

      - name: Build and check
        run: |
          cmake --build build --parallel 2 2>&1 | tee build.log
          if grep -q "warning:.*\[-clang" build.log; then
            echo "::error::clang-tidy warnings detected"
            grep "warning:.*\[-clang" build.log
            exit 1
          fi

  sanitize:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      contains(github.event.pull_request.labels.*.name, 'sanitize')
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Configure with Sanitizers
        run: |
          cmake -B build -S . \
            -DBUILD_TESTING=ON \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-sanitize=vptr -fno-omit-frame-pointer" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined -fno-sanitize=vptr"

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test with Sanitizers
        env:
          QT_QPA_PLATFORM: offscreen
          ASAN_OPTIONS: "detect_leaks=0:halt_on_error=1"
          UBSAN_OPTIONS: "halt_on_error=1:print_stacktrace=1"
        run: cd build && ctest --output-on-failure

  coverage:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.*'
          modules: 'qtcharts'

      - name: Install gcovr
        run: pip install gcovr

      - name: Configure with Coverage
        run: |
          cmake -B build -S . -DBUILD_TESTING=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

      - name: Build
        run: cmake --build build --parallel 2

      - name: Test
        env:
          QT_QPA_PLATFORM: offscreen
        run: cd build && ctest --output-on-failure

      - name: Generate Coverage Report
        run: |
          gcovr --root src --object-directory build \
            --xml build/coverage.xml \
            --html-details build/coverage.html \
            --print-summary | tee build/coverage-summary.txt

      - name: Coverage Summary
        run: |
          echo "## Code Coverage" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat build/coverage-summary.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            build/coverage.xml
            build/coverage.html*
            build/coverage-summary.txt

  translation-check:
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check unfinished translations
        run: |
          # 現在の閾値（未翻訳数がこれを超えたら fail）
          # 翻訳を追加するたびに閾値を下げること（CLAUDE.md 参照）
          THRESHOLD=1211
          total=0
          echo "## Translation Status" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| File | Unfinished |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|-----------|" >> "$GITHUB_STEP_SUMMARY"
          for f in resources/translations/*.ts; do
            count=$(grep -c 'type="unfinished"' "$f" || true)
            total=$((total + count))
            echo "| $(basename "$f") | $count |" >> "$GITHUB_STEP_SUMMARY"
          done
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Total unfinished: $total** (threshold: $THRESHOLD)" >> "$GITHUB_STEP_SUMMARY"
          if [ "$total" -gt "$THRESHOLD" ]; then
            echo "::error::Translation regression: $total unfinished (threshold: $THRESHOLD)"
            exit 1
          fi
          if [ "$total" -gt 0 ]; then
            echo "::warning::$total unfinished translation(s) found (threshold: $THRESHOLD)"
          fi
