# 人間対人間の対局後の再対局テスト

このドキュメントは、ShogiBoardQで人間対人間の対局を行った後、棋譜の途中から再対局した場合に、
将棋盤の局面、棋譜欄の棋譜、分岐候補欄の指し手、分岐ツリーが常に一致していることを確認する手動テストを説明します。

## テストの目的

対局後の再対局において、以下のバグが再発しないことを確認する：
- 棋譜を読み込んで途中局面から対局させると分岐のラインがずれて指し手が追加されてしまう問題
- 対局後、途中の局面から再対局するとGUIがハングアップする問題
- 分岐ライン上で再対局した場合、新しい指し手が誤って本譜に追加される問題

## 最重要テスト：1手進むボタンによる局面連続性の確認

**このテストは全てのテストシナリオにおいて最も重要である。**

### テスト内容

「1手進む」ボタンで局面を進めた場合、**前の局面（N手目）とその後の局面（N+1手目）の駒全体の配置が正しく連続していること**を確認する。

### 確認方法

1. 任意の局面（N手目）で将棋盤の駒配置を目視確認する
2. 「1手進む」ボタンをクリックする
3. N+1手目の局面で以下を確認：
   - **移動した駒のみが移動している**（棋譜欄に表示された指し手と一致）
   - **その他の全ての駒は前の局面と同じ位置にある**
   - 駒を取った場合は、取られた駒が盤上から消え、持ち駒に追加されている
   - 成りの場合は、駒が成った状態で表示されている

### なぜ最重要なのか

分岐棋譜において、以下のような操作を行った後に「1手進む」ボタンを押すと、
**誤って別のラインの局面が表示される**バグが発生しやすい：

- 分岐ツリーで分岐ラインを選択した後
- 分岐候補欄で分岐を選択した後
- 「本譜へ戻る」を実行した後
- 棋譜欄の行を直接クリックした後

このバグが発生すると、ユーザーは以下のような異常な状態を目にする：

```
例：3手目（▲6六歩）の局面から「1手進む」を押したのに、
    本譜の4手目（△8四歩）ではなく、
    分岐の4手目（△9四歩）の局面が表示される
    → 8四の歩ではなく9四の歩が動いている状態になる
```

### 具体的なテスト手順

#### ケース1: 分岐選択後の1手進む

```
1. 分岐棋譜を読み込む（本譜と分岐1がある状態）
2. 分岐ツリーで分岐ライン1の3手目をクリック
3. 将棋盤の駒配置を確認（例：6六に歩がある）
4. 「1手進む」ボタンをクリック
5. 将棋盤が4手目の局面になっていることを確認：
   - 3手目から4手目への指し手（棋譜欄に表示）が反映されている
   - その他の駒は3手目と同じ位置にある
```

#### ケース2: 本譜と分岐を行き来した後の1手進む

```
1. 分岐棋譜を読み込む
2. 分岐ツリーで分岐ライン1を選択
3. 「本譜へ戻る」をクリック
4. 「1手戻る」ボタンを数回クリック
5. 将棋盤の駒配置を確認
6. 「1手進む」ボタンをクリック
7. 将棋盤が正しく1手だけ進んでいることを確認
```

#### ケース3: 再対局後の1手進む

```
1. 人間対人間で対局して終了
2. 途中局面から再対局して分岐を作成
3. 対局終了後、分岐ツリーで本譜を選択
4. 「先頭へ」ボタンで開始局面に移動
5. 「1手進む」ボタンを連続でクリック
6. 各手で将棋盤が正しく1手ずつ進んでいることを確認：
   - 本譜の指し手が順番に反映される
   - 分岐ラインの指し手が混入していない
```

### 期待結果

- [ ] 「1手進む」ボタンで、**常に現在のラインの次の指し手**が盤面に反映される
- [ ] 別のラインの指し手が表示されることは**絶対にない**
- [ ] 駒配置は前の局面から論理的に連続している（ワープしない）

## 4表示の一致確認

テストでは以下の4つの表示が常に一致していることを確認する：

1. **将棋盤の局面**: 現在表示されている盤面
2. **棋譜欄の棋譜**: 棋譜リストの指し手表示と現在のハイライト行
3. **分岐候補欄の指し手**: 分岐がある場合の候補リスト
4. **分岐ツリー**: 分岐ツリーウィジェットのハイライト

## 不一致の具体例と確認ポイント

以下は実際に発生した不一致の例である。テスト時にはこのような状態になっていないことを確認する。

### 例：将棋盤と棋譜欄/分岐ツリーの不一致

**状況**:
- 棋譜欄: 5手目「▲4八銀(39)」がハイライトされている
- 分岐ツリー: 分岐ライン1の5手目「▲4八銀(39)」がオレンジ色でハイライト
- 分岐候補欄: 「▲2五歩(26)」「▲4八銀(39)」「本譜へ戻る」が表示

**期待される将棋盤の状態**（5手目▲4八銀の局面）:
```
分岐1のルート: ▲7六歩 → △3四歩 → ▲2六歩 → △8四歩 → ▲4八銀

期待される駒配置:
- 7六に歩がある（1手目）
- 3四に歩がある（2手目）
- 2六に歩がある（3手目）
- 8四に歩がある（4手目）← 重要
- 4八に銀がある（5手目）
```

**実際の将棋盤の状態**（バグ発生時）:
```
- 7六に歩がある ✓
- 3四に歩がある ✓
- 2六に歩がある ✓
- 8四に歩がない ✗ （8三に歩がある＝3手目の状態）
- 4八に銀がある ✓
```

**問題点**:
- 8四に歩がない（4手目△8四歩が反映されていない）
- しかし4八に銀がある（5手目▲4八銀は反映されている）
- **将棋盤が「3手目の局面 + 5手目の指し手」という矛盾した状態になっている**

### 確認すべきチェックポイント

| 確認項目 | 正常 | 異常（上記例） |
|---------|------|---------------|
| 棋譜欄のハイライト行 | 5手目 | 5手目 |
| 分岐ツリーのハイライト | 5手目ノード | 5手目ノード |
| 将棋盤の手数 | 5手目の局面 | **3手目+5手目が混在** |
| 8四の歩 | ある | **ない** |
| 4八の銀 | ある | ある |

### このような不一致が発生するパターン

1. **分岐選択後のナビゲーション**
   - 分岐ツリーで分岐ラインを選択
   - 「1手進む」「1手戻る」を繰り返す
   - 将棋盤の更新が棋譜欄/分岐ツリーと同期しなくなる

2. **再対局開始時の状態引継ぎ**
   - 分岐ライン上で再対局を開始
   - 棋譜欄は新しいラインを表示
   - 将棋盤が以前のラインの局面を維持してしまう

3. **「本譜へ戻る」後の操作**
   - 分岐ライン上で「本譜へ戻る」をクリック
   - その後「1手進む」で進める
   - 将棋盤が本譜ではなく以前の分岐ラインの局面を表示

### 不一致発見時の確認手順

1. **将棋盤の駒を1つずつ確認**
   - 棋譜欄の各指し手が将棋盤に正しく反映されているか
   - 特に分岐点の手前後の駒配置に注意

2. **手数を逆算して確認**
   - 現在の手数から逆算して、その手数に至るまでの全ての指し手が反映されているか
   - 例：5手目なら、1〜4手目の全ての指し手が盤面に反映されているべき

3. **SFENの比較**（開発者向け）
   - テストモードの `--dump-state-after` オプションで `actualSfen` を出力
   - 期待されるSFENと比較

## テストシナリオ

### シナリオ1: 人間対人間の対局 → 途中から再対局

#### 手順

1. **初期対局**
   - メニューから「ゲーム」→「人間 vs 人間」を選択して対局開始
   - 以下の手順で対局（例）：
     ```
     1. ▲7六歩
     2. △3四歩
     3. ▲2六歩
     4. △8四歩
     5. ▲2五歩
     6. △8五歩
     7. ▲7八金
     ```
   - 「投了」または「中断」で対局終了

2. **途中局面への移動**
   - 棋譜欄で3手目（▲2六歩）をクリック
   - または、「1手戻る」ボタンを4回クリックして3手目に移動

3. **途中から再対局開始**
   - メニューから「ゲーム」→「人間 vs 人間」を選択
   - 3手目から新しい対局を開始

4. **新しい指し手を追加**
   - 3手目の局面から別の手を指す（例）：
     ```
     3. ▲6六歩（本譜の▲2六歩とは異なる手）
     4. △8四歩
     5. ▲6五歩
     ```

5. **4表示の一致確認**（詳細は後述）

#### 期待結果

- 分岐ツリーに新しいラインが追加される
- 新しい指し手は3手目（▲6六歩）を起点とする分岐として追加される
- 棋譜欄、分岐候補欄、分岐ツリーの表示が全て一致する
- 本譜（ライン0）と新しい分岐（ライン1）が正しく区別される

### シナリオ2: 分岐ライン上から再対局

#### 手順

1. **棋譜の準備**
   - シナリオ1を実行して分岐を作成するか、以下の内容で `test_rematch.kif` を作成して読み込む：

   ```
   # ---- 再対局テスト用棋譜 ----
   手合割：平手
   先手：テスト先手
   後手：テスト後手

      1 ７六歩(77)
      2 ３四歩(33)
      3 ２六歩(27)
      4 ８四歩(83)
      5 ２五歩(26)
      6 ８五歩(84)
      7 ７八金(69)

   変化：3手
      3 ６六歩(67)
      4 ８四歩(83)
      5 ６五歩(66)
   ```

2. **分岐ラインへの移動**
   - 分岐ツリーでライン1（６六歩の分岐）の4手目をクリック

3. **分岐ラインの途中から再対局**
   - メニューから「ゲーム」→「人間 vs 人間」を選択
   - 分岐ライン1の4手目から新しい対局を開始

4. **新しい指し手を追加**
   - 分岐ラインの4手目から別の手を指す（例）：
     ```
     5. ▲7七角（分岐ライン1の▲6五歩とは異なる手）
     6. △3二金
     ```

5. **4表示の一致確認**

#### 期待結果

- 新しい分岐は分岐ライン1の4手目（△8四歩）から分岐する
- **重要**: 本譜（ライン0）の4手目（△8四歩）からではない
- 分岐ツリーの罫線が正しく分岐ライン1から引かれる
- 棋譜欄には分岐ライン2のパス（1.▲7六歩 → 2.△3四歩 → 3.▲6六歩 → 4.△8四歩 → 5.▲7七角 → 6.△3二金）が表示される

### シナリオ3: 本譜と分岐を交互に操作

#### 手順

1. **分岐棋譜の読み込み**
   - シナリオ1または2で作成した分岐棋譜を使用

2. **分岐ラインを選択**
   - 分岐ツリーでライン1を選択

3. **本譜に戻る**
   - 分岐候補欄の「本譜へ戻る」をクリック
   - または分岐ツリーで本譜（ライン0）をクリック

4. **本譜から再対局**
   - 本譜の途中（例：5手目）から再対局を開始
   - 新しい指し手を追加

5. **4表示の一致確認**

#### 期待結果

- 本譜から開始した再対局の指し手は本譜の子として追加される
- 既存の分岐（ライン1）の親子関係は変更されない
- 全ての分岐の罫線が正しく描画される

### シナリオ4: 複数回の再対局

#### 手順

1. **初期対局（1局目）**
   - 人間対人間で7手まで対局して終了

2. **1局目の3手目から再対局（2局目）**
   - 3手目から別の手で対局して終了（分岐ライン1を作成）

3. **1局目の5手目から再対局（3局目）**
   - 本譜の5手目から別の手で対局して終了（分岐ライン2を作成）

4. **2局目（分岐ライン1）の4手目から再対局（4局目）**
   - 分岐ライン1の4手目から別の手で対局して終了（分岐ライン3を作成）

5. **各操作後に4表示の一致確認**

#### 期待結果

- 各分岐が正しい親子関係で作成される：
  - 分岐1: 本譜の2手目から分岐
  - 分岐2: 本譜の4手目から分岐
  - 分岐3: 分岐1の3手目から分岐
- 分岐ツリーの罫線が全て正しく描画される
- どの分岐ラインを選択しても、4表示が一致する

## 4表示一致確認の詳細チェックリスト

各テストシナリオで以下を確認する：

### 1. 将棋盤の局面（最重要）

**「1手進む」による局面連続性の確認は必須。詳細は「最重要テスト」セクション参照。**

- [ ] 現在の手数に対応する駒配置が表示されている
- [ ] 先手/後手の手番表示が正しい
- [ ] 持ち駒の表示が正しい
- [ ] **「1手進む」で前の局面から1手分だけ駒が移動している**（別ラインの局面にならない）
- [ ] **「1手戻る」で現在の局面から1手分だけ駒が戻っている**（別ラインの局面にならない）

### 2. 棋譜欄の棋譜

- [ ] 現在のラインの指し手が表示されている（分岐ライン上では分岐の指し手）
- [ ] 現在の手数がハイライトされている
- [ ] 分岐点には「+」マークが表示されている
- [ ] 行番号が正しい（1から連番）

### 3. 分岐候補欄の指し手

- [ ] 分岐点では複数の候補が表示される
- [ ] 分岐ライン上では「本譜へ戻る」が表示される
- [ ] 分岐点以外では候補が1つ（または0）
- [ ] 各候補をクリックすると正しいラインに移動する

### 4. 分岐ツリー

- [ ] 現在位置のノードがハイライトされている
- [ ] 現在のラインが選択状態で表示されている
- [ ] 各ラインの罫線が正しい親ノードから引かれている
- [ ] ノードをクリックすると正しい局面に移動する

### 操作後の一致確認

以下の操作後に4表示が一致することを確認：

- [ ] 棋譜欄の行をクリックした後
- [ ] 分岐候補をクリックした後
- [ ] 分岐ツリーのノードをクリックした後
- [ ] 「1手進む」ボタンをクリックした後
- [ ] 「1手戻る」ボタンをクリックした後
- [ ] 「先頭へ」ボタンをクリックした後
- [ ] 「末尾へ」ボタンをクリックした後

## 自動テストとの対応

以下のユニットテストが関連する機能をカバーしている：

| 手動テストシナリオ | 対応する自動テスト |
|-------------------|-------------------|
| シナリオ1 | `testStartFromMidPositionTrimsRecordModel` |
| シナリオ2 | `testRematchFromBranchLineAddsMoveToCorrectLine` |
| シナリオ3 | `testClickMainLineWhileOnBranch`, `testRematchFromMainLineAfterBranch` |
| シナリオ4 | `testBranchParentIndexPreservedAfterRematch` |

## トラブルシューティング

### 4表示が一致しない場合

1. **棋譜欄と将棋盤が一致しない**
   - 分岐選択後にナビゲーション状態が正しくリセットされていない可能性
   - `KifuNavigationState::currentLineIndex()` の値を確認

2. **分岐ツリーのハイライトがずれる**
   - `KifuDisplayCoordinator::highlightBranchTree()` のロジックを確認
   - ライン選択記憶（`m_lastSelectedLineAtBranch`）が正しく更新されているか確認

3. **再対局後に分岐の罫線が正しくない**
   - `BranchLine.branchPoint` が正しく設定されているか確認
   - `LiveGameSession::addMove()` で親ノードが正しく参照されているか確認

### GUIがハングアップする場合

- 無限ループや再帰呼び出しが発生している可能性
- シグナル/スロット接続でのフィードバックループを確認
- `m_skipBoardSyncForBranchNav` などのフラグ状態を確認

## 関連ソースファイル

- `src/ui/coordinators/kifudisplaycoordinator.cpp` - 棋譜表示・分岐ツリー連携
- `src/navigation/kifunavigationcontroller.cpp` - ナビゲーションロジック
- `src/kifu/kifunavigationstate.cpp` - ナビゲーション状態管理
- `src/game/gamestartcoordinator.cpp` - 対局開始フロー
- `src/kifu/livegamesession.cpp` - ライブ対局セッション
- `tests/tst_kifudisplaycoordinator.cpp` - 自動テスト

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-02-03 | 初版作成 |
| 2026-02-03 | 最重要テスト（1手進むボタンによる局面連続性確認）セクションを追加 |
| 2026-02-03 | 不一致の具体例と確認ポイントセクションを追加（実際のスクリーンショットに基づく） |
