# コード品質の観察と改善余地

コードベース全体のレビューで感じた、改善の余地がある4点をまとめる。

---

## 1. MainWindow がまだ大きい

リファクタリングで 5,368行 → 4,388行へ約22%削減されており、方向性は正しい。ただし依然として「神クラス」の傾向がある。

### 現状の課題

- メンバ変数が約111個
- `ensure*()` メソッドが37個
- `connect()` 呼び出しが71箇所
- 50行超のメソッドが14個

### 改善の方向性

段階的な対処が進行中であり、引き続き以下を検討する：

- 長大メソッド（`resetToInitialState` 164行、`ensureMatchCoordinatorWiring` 117行等）のフェーズ別分解
- 関連するメンバ変数のサブシステムへの集約（解析系、棋譜系、対局系、Dock系）

---

## 2. スマートポインタの活用が限定的

`std::unique_ptr` の使用が約10箇所にとどまり、大半が Qt の親子管理に委ねられている。Qt の慣習としては妥当だが、Qt 管理外のオブジェクトには改善の余地がある。

### 該当例

```cpp
// 明示的な delete が散在している箇所
// pvboarddialog.cpp
delete m_fromHighlight;
delete m_toHighlight;

// engineregistrationdialog.cpp
delete m_process;

// gamestartcoordinator.cpp
delete m_match;
```

### 改善の方向性

Qt 親子関係に属さないオブジェクトには `std::unique_ptr` を使用し、明示的な `delete` を排除する。デストラクタでの手動解放が不要になり、コード変更時のパス漏れによるメモリリークを防止できる。

---

## 3. 一部のパーサーの複雑さ

KIF/KI2 パーサーなどで、正規表現と条件分岐が深くネストしている箇所がある。将棋の棋譜フォーマット自体の複雑さを考えると仕方ない面もあるが、extract-method で分割する余地はある。

### 改善の方向性

- 深くネストした条件分岐を意味のある名前のメソッドに抽出する
- KIF/KI2/CSA/USI 間で重複する文字列分解・数字変換・駒表現変換のロジックを共通ユーティリティに集約し、バグ修正の水平展開漏れを防ぐ

---

## 4. エラーハンドリングの一貫性

`ErrorBus` が用意されているが、全体的に使用されているわけではなく、一部の関数では入力検証が省略されている。

### 現状の課題

- `std::optional` の活用が限定的で、パース結果を空文字列や `bool` で返す箇所がある
- `Q_ASSERT` はリリースビルドで無効化されるため、安全網として不十分
- 文字列→整数変換でバリデーションなしのパターンが存在する

### 改善の方向性

- パース系関数の戻り値に `std::optional` を導入し、失敗を型で表現する
- リリースビルドでも有効なチェックが必要な箇所では `Q_ASSERT` を `if (Q_UNLIKELY(...))` + `ErrorBus` に置き換える
- 外部入力（棋譜ファイル、USI エンジン出力等）のシステム境界で入力検証を徹底する
