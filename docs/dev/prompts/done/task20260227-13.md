# Task 13: parsecommon 抽出 — 第1段（ISSUE-031）

## フェーズ
D: 変換器共通化と異常系強化

## 前提条件
- Task 12（ISSUE-030: Converter 共通パイプライン設計）が完了していること
- 設計文書 `docs/dev/converter-pipeline-design.md` が存在すること

## 目的
各コンバータに重複している基礎処理を `parsecommon` に集約し、重複行を削減する。

## 対象ファイル
- `src/kifu/formats/parsecommon.h` — 共通関数の宣言先
- `src/kifu/formats/parsecommon.cpp` — 共通関数の実装先
- `src/kifu/formats/kiftosfenconverter.cpp` — 抽出元（KIF固有→共通化）
- `src/kifu/formats/ki2tosfenconverter.cpp` — 抽出元（KI2固有→共通化）
- `src/kifu/formats/csatosfenconverter.cpp` — 抽出元（CSA固有→共通化）
- `src/kifu/formats/jkftosfenconverter.cpp` — 抽出元（JKF固有→共通化）
- 設計文書: `docs/dev/converter-pipeline-design.md`

## 詳細手順

### Step 1: 設計文書の確認
`docs/dev/converter-pipeline-design.md` を読み、共通化対象の処理を確認する。

### Step 2: 現在の parsecommon の確認
```
src/kifu/formats/parsecommon.h
src/kifu/formats/parsecommon.cpp
```
を読み、既存の共通関数と不足している共通処理を把握する。

### Step 3: 共通化対象の実装
以下の処理を `parsecommon` に追加:

1. **数値変換ユーティリティ**
   - 漢数字 → int 変換（全角数字・漢数字・算用数字対応）
   - 筋（列）・段（行）の座標変換

2. **駒表記変換**
   - 日本語駒名 → PieceType 変換
   - CSA形式駒コード → PieceType 変換

3. **時間情報パース**
   - 消費時間文字列のパース（各形式共通部分）

4. **エラーハンドリング共通**
   - パースエラーの統一的な報告メカニズム

### Step 4: 各コンバータの重複コードを共通関数呼び出しに置換
- 一度に全コンバータを変更するのではなく、まず2つ（KIF, KI2）から開始
- 各変更後にテスト実行して回帰なしを確認

### Step 5: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
# 変換器テスト
cd build && ctest --output-on-failure -R converter
```

## 完了条件
- [ ] 変換器テストが全 Pass
- [ ] `parsecommon` に共通関数が追加されている
- [ ] 少なくとも2つのコンバータで重複が削減されている
- [ ] 重複行が目に見える形で減少している

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure -R converter
wc -l src/kifu/formats/parsecommon.cpp
wc -l src/kifu/formats/kiftosfenconverter.cpp src/kifu/formats/ki2tosfenconverter.cpp
```
