# Task 17: delete 削減バッチ1 — 低リスク（ISSUE-040）

## フェーズ
E: 所有権統一の仕上げ

## 前提条件
- Task 03（ISSUE-003: 所有権ルール明文化）が完了していること
- `docs/dev/ownership-guidelines.md` が存在すること

## 目的
安全な箇所から手動 `delete` を除去し、parent ownership / スマートポインタに置換する。

## 対象ファイル
- `src/engine/engineprocessmanager.cpp` — エンジンプロセス管理
- `src/board/boardinteractioncontroller.cpp` — 盤面操作コントローラ

## 詳細手順

### Step 1: 所有権ガイドラインの確認
```
docs/dev/ownership-guidelines.md
```
を読み、置換ルールを確認する。

### Step 2: engineprocessmanager.cpp の分析
1. ファイルを読み、`delete` の使用箇所を全て特定
2. 各 `delete` について以下を確認:
   - 対象オブジェクトの型（QObject 派生か否か）
   - 所有権の流れ（誰が `new` し、誰が `delete` するか）
   - parent が設定されているか
   - 破棄順序の依存関係
3. 置換方針を決定:
   - QObject 派生 → parent ownership（`new QObject(this)` + `delete` 削除）
   - 非 QObject → `std::unique_ptr` に置換
   - 置換困難 → 理由をコメントに残して保留

### Step 3: engineprocessmanager.cpp の修正
- `delete` を parent ownership または `unique_ptr` に置換
- ヘッダーファイルのメンバ変数の型も適宜変更（`T*` → `std::unique_ptr<T>`）
- forward declare の必要性を確認（unique_ptr の場合、デストラクタを .cpp で定義）

### Step 4: boardinteractioncontroller.cpp の分析と修正
Step 2-3 と同様の手順で実施。

### Step 5: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

### Step 6: delete 件数の確認
```bash
grep -rn 'delete ' src --include="*.cpp" | grep -v '//' | grep -v '#include' | wc -l
```

## 注意事項
- Qt の `deleteLater()` は `delete` とは別管理なので対象外
- `QLayout::removeWidget()` 後の `delete` は Qt の仕様上必要な場合がある（要確認）
- `unique_ptr` に変更する場合、ヘッダーで `= default` のデストラクタを宣言し、.cpp で定義する（forward declare 対応）

## 完了条件
- [ ] 振る舞い互換（全テスト Pass）
- [ ] 対象2ファイルの `delete` が削減されている
- [ ] 置換困難な箇所には理由コメントが残されている
- [ ] 構造KPIテストが Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
grep -rn 'delete ' src --include="*.cpp" | grep -v '//' | grep -v '#include' | wc -l
cd build && ctest --output-on-failure -R tst_structural_kpi
```
