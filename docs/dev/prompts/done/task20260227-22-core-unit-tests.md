# Task 22: コアゲームロジックのユニットテスト追加

## 目的
`src/core/` のゲームロジック（ShogiBoard, MoveValidator, ShogiMove 等）に対するユニットテストを作成し、リファクタリングの安全網を構築する。

## 背景
既存のテスト（Task 01-02）は構造的KPIとレイヤー依存方向の検証であり、ゲームロジック自体の正しさを検証するユニットテストが不足している。
`src/core/` は Qt GUI 非依存の純粋なロジック層であり、ユニットテストに最も適している。

棋譜変換器にはテスト（`tst_kifconverter.cpp` 等）が存在するが、コアロジックにはテストがない。

## 作業内容

### 1. テスト対象の分析
以下のクラスの公開 API を確認し、テストケースを設計する:

#### ShogiBoard
- 初期配置の正しさ（平手・各種駒落ち）
- SFEN の読み込みと生成（ラウンドトリップ）
- 駒の移動（盤上移動・駒打ち・成り）
- 持ち駒の管理（取得・使用）
- 盤面のリセット

#### MoveValidator / EngineMoveValidator
- 合法手の判定（各駒種別）
- 不正手の検出（二歩、打ち歩詰め、王手放置等）
- 成り判定（強制成り含む）

#### ShogiMove
- USI形式の指し手パース・生成
- 指し手の同値判定
- 特殊手（投了、中断等）の扱い

#### ShogiUtils
- 座標変換
- 駒名変換
- その他ユーティリティ関数

### 2. テストの実装
- `tests/` ディレクトリにテストファイルを作成する
- Qt Test フレームワーク（QTest）を使用する（既存テストに合わせる）
- 各クラスに対応するテストファイルを作成:
  - `tst_shogiboard.cpp`
  - `tst_movevalidator.cpp`
  - `tst_shogimove.cpp`
  - `tst_shogiutils.cpp`

### 3. テストケースの優先度
以下の順で実装する:

#### 高優先度（リファクタリングの安全網）
- ShogiBoard の SFEN ラウンドトリップ
- 基本的な駒移動と持ち駒管理
- 合法手判定の基本ケース

#### 中優先度（エッジケース）
- 特殊ルール（千日手、持将棋、入玉）
- 駒落ち初期配置
- 不正手の検出

#### 低優先度（網羅性）
- 全駒種の移動パターン
- 境界値テスト

### 4. CMake 統合
- `CMakeLists.txt` にテストターゲットを追加する
- `ctest` で実行可能にする

## 完了条件
- [ ] ShogiBoard のユニットテストが 20 ケース以上ある
- [ ] MoveValidator のユニットテストが 15 ケース以上ある
- [ ] ShogiMove のユニットテストが 10 ケース以上ある
- [ ] 全テストが通る
- [ ] `ctest` で一括実行できる

## 注意事項
- `src/core/` は Qt GUI 非依存だが、QObject を継承しているクラスがあるため QTest を使用する
- 既存の棋譜変換器テスト（`tst_kifconverter.cpp` 等）のスタイルに合わせる
- テストデータとして実際の棋譜（SFEN）を使用する場合は `tests/data/` に配置する
- 外部ライブラリ（FMV）への依存がある場合はテスト環境で利用可能か確認する
