# Task 08: csagamecoordinator.cpp 分割（ISSUE-020）

## フェーズ
C: 巨大ファイル上位の削減

## 前提条件
- Task 01（ISSUE-001）、Task 02（ISSUE-002）が完了していること

## 目的
最大級ファイル `csagamecoordinator.cpp`（1569行）を分割し、変更リスクを低減する。

## 現状
- `src/network/csagamecoordinator.cpp`: 1569行（プロジェクト最大）
- CSA通信対局の全責務（接続管理・プロトコル処理・対局ロジック・UI通知）が集中

## 対象ファイル
- `src/network/csagamecoordinator.h` — 分割元ヘッダー
- `src/network/csagamecoordinator.cpp` — 分割元実装
- `src/network/csaclient.h/.cpp` — CSAクライアント（参照）
- 新規クラスファイル
- `CMakeLists.txt`

## 詳細手順

### Step 1: 責務の分析
`csagamecoordinator.cpp` を全文読み、メソッドを以下に分類:

1. **通信状態管理** — 接続/切断/ログイン/ログアウトの状態遷移
2. **コマンド送受信** — CSAプロトコルのメッセージ送信・応答パース
3. **対局ロジック** — 手の実行・時計管理・勝敗判定
4. **UI通知** — シグナル発行・表示更新指示

### Step 2: 分割クラスの設計
既存パターン（Refs/Hooks）に従い、以下の分割を検討:

- **CsaConnectionManager** — 接続状態管理（接続/切断/再接続）
- **CsaProtocolHandler** — プロトコルメッセージの送受信処理
- **CsaGameFlowController** — 対局進行ロジック

### Step 3: state 抽出の実装（PR-020-a 相当）
1. 接続状態関連のメソッドとメンバ変数を `CsaConnectionManager` へ移動
2. `CsaGameCoordinator` から委譲呼び出し
3. テスト実行

### Step 4: コマンド/レスポンス処理の抽出（PR-020-b 相当）
1. プロトコルメッセージ処理を独立クラスへ移動
2. 対局進行ロジックとの分離
3. テスト実行

### Step 5: CMakeLists.txt の更新
新規ファイルを追加。`scripts/update-sources.sh` で確認。

### Step 6: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] 既存通信テスト・関連テストが全 Pass
- [ ] `csagamecoordinator.cpp` の行数が大幅に削減（目標: 800行以下）
- [ ] 各分割クラスの責務が明確
- [ ] 構造KPIテストが Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
wc -l src/network/csagamecoordinator.cpp src/network/csagamecoordinator.h
cd build && ctest --output-on-failure -R tst_structural_kpi
```
