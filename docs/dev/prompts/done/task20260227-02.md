# Task 02: CIで構造KPI必須化（ISSUE-002）

## フェーズ
A: ガードレール先行

## 前提条件
- Task 01（ISSUE-001: 構造KPIテスト拡張）が完了していること

## 目的
構造KPIテストをCIの必須ジョブとして組み込み、PRマージ時に構造違反を確実にブロックする。

## 対象ファイル
- `.github/workflows/ci.yml` — CI定義ファイル

## 詳細手順

### Step 1: 現状のCI構成を確認
```
.github/workflows/ci.yml
```
を読み、現在のジョブ構成を把握する。現時点では以下の構成:
- `build-and-test`: Release build + unit tests
- `build-debug`: Debug build + unit tests
- `static-analysis`: clang-tidy
- translation-check: 翻訳閾値チェック

### Step 2: 構造KPIテストの実行を既存テストジョブで確認
`build-and-test` ジョブで `ctest` 実行時に `tst_structural_kpi` が含まれているか確認。
既に含まれている場合は、fail時にCIが失敗することを確認するだけでよい。

### Step 3: fail時の要約出力改善
テスト失敗時にどのKPIが閾値を超えたか分かりやすくするため、GitHub Step Summaryへ情報を出力する。

```yaml
    - name: Run structural KPI tests
      if: always()
      run: |
        cd build
        ctest --output-on-failure -R tst_structural_kpi 2>&1 | tee kpi-results.txt
        if grep -q "FAILED" kpi-results.txt; then
          echo "## Structural KPI Check Failed" >> $GITHUB_STEP_SUMMARY
          grep "FAIL" kpi-results.txt >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
```

### Step 4: 構造KPIテストの独立実行ステップ化（オプション）
テスト全体が失敗したときに構造KPIの問題かどうか判別しやすくするため、構造KPIテストを独立ステップとして実行することを検討する。ただし既存の`ctest`に含まれている場合は二重実行になるので、Step Summaryへの出力追加のみで十分。

### Step 5: ビルド確認
ローカルでCIと同じコマンドを実行して確認:
```bash
cmake -B build -S .
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] CIで構造KPIテストが実行される
- [ ] 構造KPI違反時にCIがFail する
- [ ] fail時の出力がGitHub Step Summaryで確認可能
- [ ] 既存のCIジョブが壊れていない

## 検証コマンド
```bash
# ローカルでCI相当の実行
cd build && ctest --output-on-failure -R tst_structural_kpi
```
