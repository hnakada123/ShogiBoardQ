# Task 04: MatchCoordinator 分割設計（ISSUE-010）

## フェーズ
B: 高リスク領域の分割（司令塔）

## 前提条件
- Task 01（ISSUE-001）、Task 02（ISSUE-002）が完了していること

## 目的
`MatchCoordinator` の責務をユースケース単位に分解する設計を文書化する。
コード変更は行わず、設計文書のみを成果物とする。

## 現状の課題
- `matchcoordinator.cpp`: 約797行（以前1444行から削減済み）
- `matchcoordinator.h`: 約565行
- `Hooks` 構造体に21個のコールバックが集中
- 対局開始・時計・終局・USI連携・UI通知が混在
- 既に `GameEndHandler`, `EngineLifecycleManager`, `MatchTimekeeper`, `GameStartOrchestrator` を抽出済み

## 対象ファイル（読み取り対象）
- `src/game/matchcoordinator.h` — 現在の構造把握
- `src/game/matchcoordinator.cpp` — 残存責務の特定
- `src/game/gameendhandler.h/.cpp` — 既存の抽出パターン参照
- `src/game/gamestartorchestrator.h/.cpp` — 既存の抽出パターン参照
- `src/game/matchtimekeeper.h/.cpp` — 既存の抽出パターン参照
- `src/engine/enginelifecyclemanager.h/.cpp` — 既存の抽出パターン参照

## 詳細手順

### Step 1: MatchCoordinator の現在の責務を網羅的に列挙
`matchcoordinator.cpp` の全メソッドを読み、以下のカテゴリに分類する:
- **オーケストレーション** — 他のクラスへの委譲・調整のみ
- **対局状態管理** — ゲーム状態の保持・更新
- **USIエンジン連携** — エンジンへのコマンド送信・応答処理
- **UI通知** — Hooksを通じたUI更新指示
- **棋譜操作** — 棋譜への記録・SFEN管理
- **その他** — 上記に分類困難なもの

### Step 2: UseCase 候補の設計
以下の UseCase クラスを設計候補として検討:

1. **MatchStateManager** — 対局状態（進行中/停止/分析中）の保持・遷移
2. **MoveExecutionHandler** — 手の実行・検証・棋譜記録の一連処理
3. **UsiCommandBridge** — USIエンジンへのコマンド送出の抽象化

### Step 3: Hooks の分割設計
現在の21個のコールバックを用途別に分割:

```
UIHooks:
  - updateTurnDisplay
  - setPlayersNames
  - setEngineNames
  - setGameActions
  - renderBoardFromGc
  - showGameOverDialog
  - showMoveHighlights

TimeHooks:
  - remainingMsFor
  - incrementMsFor
  - byoyomiMs
  - humanPlayerSide

EngineHooks:
  - sendGoToEngine
  - sendStopToEngine
  - sendRawToEngine

GameHooks:
  - initializeNewGame
  - appendKifuLine
  - appendEvalP1 / appendEvalP2
  - autoSaveKifu
```

### Step 4: 影響ファイル一覧の作成
Hooks を参照しているファイルを全て列挙する:
```bash
grep -rn "MatchCoordinator::Hooks" src/ --include="*.cpp" --include="*.h"
grep -rn "m_hooks\." src/game/ --include="*.cpp"
```

### Step 5: 設計文書の作成
`docs/dev/matchcoordinator-split-design.md` を作成:
- 現在の責務マップ
- UseCase 候補と境界
- Hooks 分割案
- 影響ファイル一覧
- 移行手順（段階的）
- リスクと対策

## 完了条件
- [ ] `docs/dev/matchcoordinator-split-design.md` が作成されている
- [ ] 全メソッドの責務分類が完了
- [ ] UseCase 候補が定義されている
- [ ] Hooks 分割案が記載されている
- [ ] 影響ファイル一覧が含まれている
- [ ] 段階的な移行手順が記載されている
- [ ] コード変更は行っていない

## 検証コマンド
```bash
# 設計文書の存在確認
ls docs/dev/matchcoordinator-split-design.md
# 現在の行数確認（設計の根拠として）
wc -l src/game/matchcoordinator.cpp src/game/matchcoordinator.h
```
