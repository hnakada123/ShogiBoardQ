# Task 03: 所有権ルール明文化（ISSUE-003）

## フェーズ
A: ガードレール先行

## 前提条件
- なし（ドキュメント追加のみ）

## 目的
`new/delete` 混在の拡大を防止するため、QObject/非QObjectの所有権ルールを文書化し、PRレビュー時の判断基準を明確にする。

## 対象ファイル
- 新規: `docs/dev/ownership-guidelines.md` — 所有権ガイドライン
- `CLAUDE.md` — 必要に応じてCode Styleセクションにリファレンスを追記

## 詳細手順

### Step 1: 現状の所有権パターン調査
以下のファイルを読み、現在のプロジェクトで使われている所有権パターンを把握する:

```
src/engine/engineprocessmanager.cpp  — delete の使用箇所
src/game/gamestartcoordinator.cpp    — delete の使用箇所
src/models/kifurecordlistmodel.cpp   — delete の使用箇所
src/board/boardinteractioncontroller.cpp — delete の使用箇所
src/app/mainwindowcompositionroot.cpp — ensure* パターン（所有権の模範例）
```

### Step 2: 所有権ガイドラインの作成
`docs/dev/ownership-guidelines.md` を新規作成する。以下の構成で記述:

```markdown
# 所有権ガイドライン

## 基本ルール

### QObject 派生クラス
- **原則**: parent ownership を使用する
- コンストラクタで `parent` を指定し、親の破棄に連動させる
- `new QObject(this)` — `this` が親となり、`this` の破棄時に自動 delete

### 非QObject クラス
- **原則**: `std::unique_ptr` を使用する
- 裸の `new` は Factory / CompositionRoot 経由に限定
- `std::make_unique<T>(...)` を優先

### 非所有参照（借用）
- 生ポインタ (`T*`) は「所有しない」ことを意味する
- Deps 構造体のメンバは全て非所有参照
- ライフサイクルは所有者が管理

## 禁止パターン
- 裸の `delete` — 代替困難な場合のみ許可（理由をコメント記載）
- `new` + 生ポインタ保持 — `unique_ptr` または parent ownership を使う
- 関数内 `new` + 手動 `delete` — RAII で置換

## 例外が許される場合
- Qt の `takeItem()` / `takeWidget()` 系API（所有権移転のため手動 delete が必要）
- `QLayout::removeWidget()` 後の解放
- 上記の場合はコメントで理由を明記

## PRレビュー観点
1. 新規 `delete` の追加 → 代替不可能か確認
2. 新規 `new` → parent 指定 or unique_ptr 使用か確認
3. 所有者の明確性 → 誰が破棄責任を持つか追跡可能か
4. 破棄順序 → 依存関係がある場合、安全な順序か
```

### Step 3: CLAUDE.md への参照追記
`CLAUDE.md` の Code Style セクションに以下を追記:

```markdown
- **所有権ルール**: `docs/dev/ownership-guidelines.md` に従う。QObject は parent ownership、非QObject は `std::unique_ptr` を基本とする。裸の `new/delete` は原則禁止
```

### Step 4: 内容の確認
ドキュメントの記述が現在のコードベースの実態と矛盾しないか確認する。

## 完了条件
- [ ] `docs/dev/ownership-guidelines.md` が作成されている
- [ ] QObject / 非QObject / 非所有参照の3分類が明記されている
- [ ] 例外パターンと理由記載ルールが含まれている
- [ ] PRレビュー観点が含まれている
- [ ] `CLAUDE.md` から参照されている

## 検証コマンド
```bash
# ドキュメントが存在することを確認
ls docs/dev/ownership-guidelines.md
# CLAUDE.md に参照があることを確認
grep -n "ownership" CLAUDE.md
```
