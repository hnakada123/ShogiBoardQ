# Task 01: 構造KPIテスト拡張（ISSUE-001）

## フェーズ
A: ガードレール先行（後戻り防止）

## 前提条件
- なし（最初に着手するタスク）

## 目的
構造劣化をCIで即検知するため、`tst_structural_kpi.cpp` に以下の監視項目を追加する:
1. **1000行超ファイル数の上限チェック**
2. **`delete` 件数の上限チェック**
3. **lambda `connect` 件数の上限チェック**

## 現状値（2026-02-27 計測）
| 指標 | 現状値 | 上限設定（現状値 + マージン） |
|---|---:|---:|
| 1000行超ファイル数 | 8 | 9 |
| `delete` 件数（src/） | 17 | 19 |
| lambda `connect` 件数 | 6 | 7 |

## 対象ファイル
- `tests/tst_structural_kpi.cpp` — KPIテストの追加先

## 詳細手順

### Step 1: 現状の確認
まず現在のテストファイルを読んで既存のテスト構造を理解する:
```
tests/tst_structural_kpi.cpp
```

### Step 2: 1000行超ファイル数チェックの追加
既存の `fileLineLimits()` テストの下に新しいテスト関数を追加する。

テスト内容:
- `src/` 配下の `.cpp` / `.h` ファイルを走査
- 各ファイルの行数を `countLines()` でカウント
- 1000行超のファイル数を集計
- 上限値（9）を超えたら FAIL

```cpp
void Tst_StructuralKpi::largeFileCount()
{
    const int kMaxLargeFiles = 9; // 現状8 + マージン1
    const int kLargeFileThreshold = 1000;

    // src/ 配下の全 .cpp/.h を走査
    // 1000行超のファイルをカウント
    // QVERIFY2(count <= kMaxLargeFiles, ...)
}
```

### Step 3: `delete` 件数チェックの追加
`src/` 配下の `.cpp` ファイルで `delete ` パターンの出現数を集計するテストを追加。

注意点:
- `// delete` のようなコメント行は除外する
- `delete[]` も含める
- `#include` 行内の `delete` は除外
- 正規表現パターン: `^\s*(delete\s|delete\[)` を使い、行頭のインデント + `delete` を検出

```cpp
void Tst_StructuralKpi::deleteCount()
{
    const int kMaxDeleteCount = 19; // 現状17 + マージン2
    // src/ 配下の .cpp を走査
    // 各ファイルで delete の出現をカウント（コメント行除外）
    // QVERIFY2(totalCount <= kMaxDeleteCount, ...)
}
```

### Step 4: lambda `connect` 件数チェックの追加
`connect(` を含む行で `[` も含む行（lambda接続の典型パターン）をカウント。

```cpp
void Tst_StructuralKpi::lambdaConnectCount()
{
    const int kMaxLambdaConnects = 7; // 現状6 + マージン1
    // src/ 配下の .cpp を走査
    // connect(..., [...] パターンをカウント
    // QVERIFY2(count <= kMaxLambdaConnects, ...)
}
```

### Step 5: テストクラスのプライベートスロットに関数宣言を追加
```cpp
private slots:
    // 既存
    void fileLineLimits();
    void mainWindowFriendClassLimit();
    void mainWindowEnsureLimit();
    void mainWindowPublicSlotsLimit();
    // 追加
    void largeFileCount();
    void deleteCount();
    void lambdaConnectCount();
```

### Step 6: ビルド・テスト実行
```bash
cmake --build build
cd build && ctest --output-on-failure -R tst_structural_kpi
```

## 完了条件
- [ ] 3つの新テスト関数が追加されている
- [ ] テストがローカルで安定実行（全Pass）
- [ ] 上限値は「現状値 + 最小マージン」で設定されている
- [ ] 既存テストが壊れていない（`ctest --output-on-failure` 全Pass）

## 検証コマンド
```bash
# 現状値の確認
find src -name "*.cpp" -o -name "*.h" | xargs wc -l | awk '$1 > 1000' | wc -l
grep -rn 'delete ' src --include="*.cpp" | grep -v '//' | grep -v '#include' | wc -l
grep -rn 'connect(' src --include="*.cpp" | grep '\[' | wc -l

# テスト実行
cd build && ctest --output-on-failure -R tst_structural_kpi
```
