# Task 05: MatchCoordinator 実装分割 — UseCase 抽出（ISSUE-011）

## フェーズ
B: 高リスク領域の分割（司令塔）

## 前提条件
- Task 04（ISSUE-010: MatchCoordinator 分割設計）が完了していること
- 設計文書 `docs/dev/matchcoordinator-split-design.md` が存在すること

## 目的
`matchcoordinator.cpp` の責務集中を実装レベルで削減する。設計文書に従い、UseCase クラスを抽出し、Hooks を用途別に分割する。

## 対象ファイル
- `src/game/matchcoordinator.h` — 既存のHooks分割・メソッド移動
- `src/game/matchcoordinator.cpp` — メソッド抽出元
- `docs/dev/matchcoordinator-split-design.md` — 設計文書（Step の根拠）
- 新規クラスファイル（設計文書に基づいて決定）
- `CMakeLists.txt` — 新規ファイルの追加

## 詳細手順

### Step 1: 設計文書の確認
`docs/dev/matchcoordinator-split-design.md` を読み、抽出対象と移行手順を確認する。

### Step 2: MatchCoordinator の現在のコードを精読
```
src/game/matchcoordinator.h
src/game/matchcoordinator.cpp
```
設計文書のUseCase分類に対応するメソッド群を特定する。

### Step 3: Hooks 分割の実装（PR-011-a 相当）
Hooks 構造体を用途別サブ構造体に分割する。

既存パターン（Refs/Hooks）を踏襲:
```cpp
struct UIHooks {
    std::function<void(Player)> updateTurnDisplay;
    std::function<void(const QString&, const QString&)> setPlayersNames;
    // ...
};

struct TimeHooks {
    std::function<int(Player)> remainingMsFor;
    // ...
};
```

MatchCoordinator 側は統合 Hooks を受け取り、内部でサブHooksに振り分ける。
後方互換を維持するため、既存の `Hooks` 構造体はそのまま残し、内部で分配する方式も可。

### Step 4: UseCase クラスの抽出（PR-011-b, PR-011-c 相当）
設計文書で定義された各 UseCase を段階的に抽出する。

抽出パターン（既存の GameEndHandler に倣う）:
1. 新クラスを作成（非QObject + unique_ptr 管理、または QObject + parent 管理）
2. `Refs` 構造体で読み取り専用の依存を注入
3. `Hooks` 構造体で上位への通知コールバックを注入
4. MatchCoordinator から対象メソッドを移動
5. MatchCoordinator にフォワーディングメソッドを残す（一時的）
6. 呼び出し元を新クラスへ直接向ける
7. 不要になったフォワーディングメソッドを削除

### Step 5: CMakeLists.txt の更新
新規ファイルを `set(SOURCES ...)` に追加。`scripts/update-sources.sh` を実行して確認。

### Step 6: ビルド・テスト
```bash
cmake -B build -S .
cmake --build build
cd build && ctest --output-on-failure
```

### Step 7: 行数確認
```bash
wc -l src/game/matchcoordinator.cpp src/game/matchcoordinator.h
```

## 完了条件
- [ ] 振る舞い互換（全テスト Pass: `ctest --output-on-failure`）
- [ ] `matchcoordinator.cpp` の行数が純減している
- [ ] `matchcoordinator.h` の行数が純減している（目標: 500行以下）
- [ ] Hooks が用途別に分割されている（または分割の準備が完了）
- [ ] 新クラスが既存の Refs/Hooks パターンに従っている
- [ ] CMakeLists.txt が更新されている
- [ ] 構造KPIテストが Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
wc -l src/game/matchcoordinator.cpp src/game/matchcoordinator.h
cd build && ctest --output-on-failure -R tst_structural_kpi
```
