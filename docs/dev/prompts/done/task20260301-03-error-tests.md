# Task 03: 異常系テスト追加（Phase 1: 設定・I/O）

## 概要

`tests/tst_app_error_handling.cpp` に異常系テストケースを6件以上追加し、設定破損・I/Oエラー・不正入力に対するロバスト性を検証する。

## 前提条件

- なし（テスト追加のため他タスクと独立して実施可能）

## 現状

- `tests/tst_app_error_handling.cpp`: 12テストスロット
- 現行テストは主に「ガードパターンの存在確認」（ソースコード構造の検証）
- 異常系の動作テスト（実際にエラー状態を作って正しく処理されるか）は不足

## 実施内容

### Step 1: テスト対象の選定

以下の異常系シナリオのテストを追加する:

#### 1. 破損SFEN入力テスト
- `ShogiBoard::setSfen()` に不正なSFEN文字列を渡した場合
  - 空文字列
  - フィールド数不足（3フィールドのみ等）
  - 不正な駒文字
  - ランク/ファイル数の不一致
- 期待: クラッシュせず、エラー状態を返すか無視する

#### 2. 破損棋譜ファイル入力テスト
- KIF/KI2/CSA/JKF 各フォーマットの `parse*()` に不正データを渡した場合
  - 空ファイル
  - バイナリデータ
  - ヘッダーのみで指し手なし
  - 途中で切れたデータ
- 期待: ParseResult がエラーを返し、クラッシュしない

#### 3. 設定ファイル破損テスト
- `SettingsService` の各 getter が QSettings のキーが欠損/型不一致の場合にデフォルト値を返すか検証
- 対象: `mainWindowSize()`, `engineSettings()`, 各ダイアログサイズ系

#### 4. CSA切断シミュレーションテスト
- `CsaClient` の状態遷移が不正な順序で呼ばれた場合のテスト
  - 未接続状態での `sendMove()`
  - ログイン前の `agree()`
  - 二重 `connectToServer()`
- 期待: クラッシュせず、適切なエラーシグナルが発行される

#### 5. USI応答欠損テスト
- USIプロトコルハンドラの `waitForUsiOk()`, `waitForReadyOk()` がタイムアウトした場合
- 不正なUSI応答行（空行、不完全な info 行）の処理
- 期待: タイムアウト→エラーシグナル、不正行→無視

#### 6. LifecyclePipeline二重初期化/終了テスト
- `runStartup()` の二重呼び出し
- `runShutdown()` の二重呼び出し（既存テストの拡充）
- 初期化未完了状態での終了
- 期待: 二重実行防止が動作する

### Step 2: テストの実装

1. 既存の `tst_app_error_handling.cpp` に追加（ファイルが大きくなりすぎる場合は `tst_error_sfen.cpp` 等に分割）
2. テストは **ソースコード構造検証**（grep/regex で確認）または **ユニットテスト**（実際にインスタンス生成して呼び出し）のどちらかを選択
3. 純粋関数（`parseSfen`, `parseMove` 等）はユニットテスト
4. QObject 依存のもの（CsaClient, UsiProtocolHandler）はソースコード構造検証

### Step 3: KPI更新

1. CMakeLists.txt にテストファイルを追加（新規ファイルの場合）
2. テスト数が +6 以上増えたことを確認

## 完了条件

- 異常系テスト +6 以上追加
- うち SFEN/棋譜パース系が +2 以上
- うち 設定/I/O系が +2 以上
- ビルド成功
- 全テスト通過（新規テスト含む）

## 注意事項

- テスト内で実際の QSettings ファイルを書き換えないこと（一時ディレクトリを使用）
- ネットワーク接続を必要とするテストは書かない（CsaClient はソースコード構造検証で対応）
- `connect()` にラムダを使わないこと（テストコード内はこの制限の対象外）
