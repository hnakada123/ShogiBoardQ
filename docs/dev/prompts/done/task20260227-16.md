# Task 16: Converter 異常系テスト拡張（ISSUE-034）

## フェーズ
D: 変換器共通化と異常系強化

## 前提条件
- Task 15（ISSUE-033: CSA/JKF/USI/USEN 移行）が完了していること

## 目的
異常入力に対する堅牢性を強化するため、コンバータの異常系テストを大幅に拡充する。

## 対象ファイル
- `tests/tst_kifconverter.cpp` — KIF コンバータテスト
- `tests/tst_ki2converter.cpp` — KI2 コンバータテスト
- `tests/tst_csaconverter.cpp` — CSA コンバータテスト
- 新規: `tests/tst_parsecommon.cpp` — 共通処理テスト（必要に応じて）
- 既存テストファイル名は実際のファイル名を確認して合わせる

## 詳細手順

### Step 1: 既存テストの確認
```bash
find tests -name "*converter*" -o -name "*parsecommon*"
```
で既存テストファイルを確認し、現在のテストケースを把握する。

### Step 2: 異常系ケースの設計
以下のカテゴリで異常系テストを設計:

#### 入力異常
- 空文字列入力
- 不正な文字コード
- 途中で切れたデータ（不完全な棋譜）
- 存在しない駒種
- 盤外座標（0筋、10筋、0段、10段）

#### 境界値
- 最長手数（500手以上の棋譜）
- 全駒打ちの局面
- 二歩の検出
- 移動不可能な手（飛車の斜め移動等）

#### フォーマット固有
- KIF: ヘッダーのみ（指し手なし）
- KI2: 曖昧な指し手表記
- CSA: 不正なコマンド
- JKF: 不正な JSON

### Step 3: テストの実装
Qt Test フレームワークのデータ駆動テスト（`_data()` メソッド）を活用:

```cpp
void Tst_KifConverter::invalidInput_data()
{
    QTest::addColumn<QString>("input");
    QTest::addColumn<bool>("shouldSucceed");

    QTest::newRow("empty") << "" << false;
    QTest::newRow("truncated") << "手数----指手-" << false;
    QTest::newRow("invalid_piece") << "..." << false;
}

void Tst_KifConverter::invalidInput()
{
    QFETCH(QString, input);
    QFETCH(bool, shouldSucceed);
    // テスト実行
}
```

### Step 4: parsecommon テストの追加
共通関数の単体テストを追加（必要であれば新規テストファイルを作成）:
- 漢数字変換の境界値
- 座標変換の範囲外入力
- 時間パースの異常形式

### Step 5: CMakeLists.txt の更新（新規テストファイルがある場合）

### Step 6: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] 各コンバータに異常系テストが追加されている
- [ ] 境界値テストが追加されている
- [ ] 全テスト Pass
- [ ] 異常入力が明示的にテストでカバーされている

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
cd build && ctest -N | grep -i converter  # converter テスト一覧
```
