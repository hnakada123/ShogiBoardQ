# Task 19: delete 削減バッチ3 — 高リスク（ISSUE-042）

## フェーズ
E: 所有権統一の仕上げ

## 前提条件
- Task 06（ISSUE-012: GameStartCoordinator 分割）が完了していること
- Task 07（ISSUE-013: 対局フロー回帰テスト）が完了していること
- Task 18（ISSUE-041: delete 削減バッチ2）が完了していること

## 目的
対局ライフサイクル中心部の手動 `delete` を縮小する。最もリスクの高い箇所のため、慎重に実施する。

## 対象ファイル
- `src/game/gamestartcoordinator.cpp` — 対局開始コーディネータ
- `src/game/shogigamecontroller.cpp` — ゲームコントローラ

## 詳細手順

### Step 1: gamestartcoordinator.cpp の分析

#### 詳細分析
1. ファイルを読み、全ての `delete` 箇所を特定
2. 各 `delete` について、対局ライフサイクルのどのフェーズで実行されるか追跡:
   - 対局開始前のリソース準備
   - 対局中のリソース入れ替え
   - 対局終了後のクリーンアップ
3. `delete` の対象オブジェクトが他のオブジェクトから参照されていないか確認
4. 破棄順序の依存関係を図示

### Step 2: shogigamecontroller.cpp の分析
同様の分析を実施。特にゲーム状態のライフサイクルに注目。

### Step 3: ライフサイクル統合の設計
- 手動 `delete` が必要な理由を整理
- 可能な箇所を `unique_ptr` または parent ownership に置換
- 対局の開始/終了/再開始サイクルでリソースが正しくリセットされることを保証
- `unique_ptr::reset()` でのリソース入れ替えパターンを活用

### Step 4: 修正の実装

#### PR-042-a: gamestartcoordinator 側
1. 安全な `delete` から順に置換
2. 各置換後にビルド・テスト実行
3. 対局開始→終了→再開始のフルサイクルテストで回帰確認

#### PR-042-b: shogigamecontroller 側
1. 同様に段階的に置換
2. フルサイクルテストで回帰確認

### Step 5: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 注意事項
- **対局ライフサイクルは最もクリティカルなパス** — 慎重に進める
- `unique_ptr::reset()` 時に関連オブジェクトへの参照が無効化されないか確認
- `deleteLater()` が必要な場合がある（signal 処理中のオブジェクト削除）
- 対局中にエンジンプロセスが動作している場合、破棄順序に要注意
- 回帰テスト（Task 07 で追加したもの）が全て Pass することを確認

## 完了条件
- [ ] 対局開始/終了/再開始の回帰なし（全テスト Pass）
- [ ] 対象2ファイルの `delete` が削減されている
- [ ] `src/` 全体の `delete` 件数が目標（8以下）に近づいている
- [ ] 構造KPIテストが Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
grep -rn 'delete ' src --include="*.cpp" | grep -v '//' | grep -v '#include' | wc -l
cd build && ctest --output-on-failure -R tst_structural_kpi
# 対局関連テスト
cd build && ctest --output-on-failure -R game
```
