# Task 12: Converter 共通パイプライン設計（ISSUE-030）

## フェーズ
D: 変換器共通化と異常系強化

## 前提条件
- Task 01（ISSUE-001）、Task 02（ISSUE-002）が完了していること

## 目的
棋譜コンバータ間の重複ロジックを削減するための共通パイプライン設計を文書化する。
コード変更は行わず、設計文書のみを成果物とする。

## 現状
- 6つのコンバータ（KIF, KI2, CSA, JKF, USI, USEN → SFEN）が個別に実装
- 各コンバータで数値変換・駒変換・座標変換・時刻解釈が重複
- `parsecommon.cpp` に一部共通処理が存在するが、活用が不十分

## 対象ファイル（読み取り対象）
- `src/kifu/formats/kiftosfenconverter.cpp` — KIF形式コンバータ
- `src/kifu/formats/ki2tosfenconverter.cpp` — KI2形式コンバータ
- `src/kifu/formats/csatosfenconverter.cpp` — CSA形式コンバータ
- `src/kifu/formats/jkftosfenconverter.cpp` — JKF形式コンバータ
- `src/kifu/formats/usitosfenconverter.cpp` — USI形式コンバータ
- `src/kifu/formats/usentosfenconverter.cpp` — USEN形式コンバータ
- `src/kifu/formats/parsecommon.h/.cpp` — 既存共通処理

## 詳細手順

### Step 1: 各コンバータの構造分析
6つのコンバータを読み、以下の処理段階を特定:
1. **Lexer（字句解析）**: テキスト → トークン列
2. **Parser（構文解析）**: トークン列 → 指し手データ
3. **MoveApplier（手適用）**: 指し手データ → 盤面更新
4. **ResultBuilder（結果構築）**: 盤面更新結果 → SFEN文字列

### Step 2: 重複ロジックの特定
各コンバータ間で重複している処理をリストアップ:
- 漢数字 → 数値変換
- 座標変換（筋・段）
- 駒種変換（各形式固有の表記 → 内部表現）
- 成/不成の判定
- 時間情報の解析
- エラーハンドリングパターン

### Step 3: 共通パイプラインのインターフェース設計
```
Lexer -> Parser -> MoveApplier -> ResultBuilder
```
各段階のインターフェースを定義:
- 各コンバータは形式固有の Lexer/Parser を持つ
- MoveApplier と ResultBuilder は共通
- Policy パターンで形式差分を吸収

### Step 4: 移行順序の決定
- 最も類似度が高い KIF/KI2 を最初に移行
- 次に CSA/JKF
- 最後に USI/USEN（最もシンプルなため最後でよい）

### Step 5: 設計文書の作成
`docs/dev/converter-pipeline-design.md` を作成:
- 現在の重複箇所マップ
- 共通パイプラインのクラス図
- 各形式の差分一覧
- 移行手順と順序
- テスト方針

## 完了条件
- [ ] `docs/dev/converter-pipeline-design.md` が作成されている
- [ ] 6コンバータの重複箇所が特定されている
- [ ] 共通パイプラインのインターフェースが定義されている
- [ ] 形式ごとの差分が整理されている
- [ ] 移行順序が決定されている
- [ ] コード変更は行っていない

## 検証コマンド
```bash
ls docs/dev/converter-pipeline-design.md
```
