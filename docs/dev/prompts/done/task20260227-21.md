# Task 21: ダイアログサイズ保存/復元の共通化実装（ISSUE-061）

## フェーズ
F: ダイアログ品質・テスト拡充

## 前提条件
- Task 20（ISSUE-060: ダイアログボイラープレート共通ユーティリティ設計）が完了していること
- 設計文書 `docs/dev/dialog-utilities-design.md` が存在すること

## 目的
12箇所に重複しているダイアログサイズ保存/復元パターンを共通ユーティリティに集約する。

## 対象ファイル（全12ダイアログ）
- 新規: `src/common/dialogutils.h` — 共通ユーティリティ宣言
- 新規: `src/common/dialogutils.cpp` — 共通ユーティリティ実装
- `src/dialogs/josekiwindowui.cpp`
- `src/dialogs/csagamedialog.cpp`
- `src/dialogs/josekimovedialog.cpp`
- `src/dialogs/pvboarddialog.cpp`
- `src/dialogs/kifuanalysisdialog.cpp`
- `src/dialogs/josekimergedialog.cpp`
- `src/dialogs/startgamedialog.cpp`
- `src/dialogs/kifupastedialog.cpp`
- `src/dialogs/sfencollectiondialog.cpp`
- `src/dialogs/engineregistrationdialog.cpp`
- `src/dialogs/changeenginesettingsdialog.cpp`
- `src/dialogs/tsumeshogigeneratordialog.cpp`
- `CMakeLists.txt` — 新規ファイル追加

## 詳細手順

### Step 1: 設計文書の確認
`docs/dev/dialog-utilities-design.md` を読み、設計に従って実装する。

### Step 2: 共通ユーティリティの実装
`src/common/dialogutils.h/.cpp` を新規作成:

```cpp
// dialogutils.h
#pragma once
#include <QSize>
#include <QWidget>
#include <functional>

namespace DialogUtils {

/// ダイアログサイズを復元する。savedSize が有効かつ最小サイズ以上なら復元、
/// そうでなければ fallbackSize を適用する。
void restoreDialogSize(QWidget* dialog, const QSize& savedSize, const QSize& fallbackSize);

/// ダイアログサイズを保存する。
void saveDialogSize(const QWidget* dialog, std::function<void(const QSize&)> setter);

} // namespace DialogUtils
```

```cpp
// dialogutils.cpp
#include "dialogutils.h"

namespace {
    constexpr int kMinWidth = 100;
    constexpr int kMinHeight = 100;
}

namespace DialogUtils {

void restoreDialogSize(QWidget* dialog, const QSize& savedSize, const QSize& fallbackSize)
{
    if (savedSize.isValid() && savedSize.width() > kMinWidth && savedSize.height() > kMinHeight) {
        dialog->resize(savedSize);
    } else {
        dialog->resize(fallbackSize);
    }
}

void saveDialogSize(const QWidget* dialog, std::function<void(const QSize&)> setter)
{
    setter(dialog->size());
}

} // namespace DialogUtils
```

### Step 3: 第1弾の移行（PR-061-a 相当 — 6ダイアログ）
以下の6ダイアログを共通ユーティリティ呼び出しに置換:
1. `josekiwindowui.cpp`
2. `csagamedialog.cpp`
3. `josekimovedialog.cpp`
4. `pvboarddialog.cpp`
5. `kifuanalysisdialog.cpp`
6. `josekimergedialog.cpp`

各ダイアログの修正パターン:
```cpp
// Before
QSize savedSize = SettingsService::xxxDialogSize();
if (savedSize.isValid() && savedSize.width() > 100 && savedSize.height() > 100) {
    resize(savedSize);
} else {
    resize(600, 500);
}

// After
DialogUtils::restoreDialogSize(this, SettingsService::xxxDialogSize(), QSize(600, 500));
```

```cpp
// Before (closeEvent)
SettingsService::setXxxDialogSize(size());

// After
DialogUtils::saveDialogSize(this, SettingsService::setXxxDialogSize);
// 注: setXxxDialogSize が static 関数なら直接渡せる
// static でなければラムダでラップ
```

### Step 4: 第2弾の移行（PR-061-b 相当 — 残り6ダイアログ）
7. `startgamedialog.cpp`
8. `kifupastedialog.cpp`
9. `sfencollectiondialog.cpp`
10. `engineregistrationdialog.cpp`
11. `changeenginesettingsdialog.cpp`
12. `tsumeshogigeneratordialog.cpp`

### Step 5: CMakeLists.txt の更新
`src/common/dialogutils.cpp` を追加。

### Step 6: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] `src/common/dialogutils.h/.cpp` が作成されている
- [ ] 12箇所の重複が共通関数呼び出しに統一されている
- [ ] 振る舞い互換（全テスト Pass）
- [ ] 各ダイアログのサイズ保存/復元が2〜3行に収まっている

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
# 重複パターンの残存確認
grep -rn "savedSize.isValid()" src/dialogs/ --include="*.cpp" | wc -l
# 共通関数の使用確認
grep -rn "DialogUtils::restoreDialogSize" src/dialogs/ --include="*.cpp" | wc -l
```
