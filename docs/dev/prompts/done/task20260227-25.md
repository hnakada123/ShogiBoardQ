# Task 25: テストカバレッジ拡充 — CSAプロトコル・設定永続化（ISSUE-065）

## フェーズ
F: ダイアログ品質・テスト拡充

## 前提条件
- Task 01（ISSUE-001）、Task 02（ISSUE-002）が完了していること

## 目的
テスト空白領域（CSAプロトコル、設定永続化）を埋め、回帰検知力を強化する。

## 現状
- 37テスト中、CSA通信プロトコルの状態遷移テストなし
- SettingsService の保存→復元ラウンドトリップテストなし
- `tst_csaconverter` はフォーマット変換のみ

## 対象ファイル
- 新規: `tests/tst_csaprotocol.cpp` — CSAプロトコルテスト
- 新規: `tests/tst_settings_roundtrip.cpp` — 設定ラウンドトリップテスト
- `src/network/csaclient.h/.cpp` — テスト対象（CSAプロトコル）
- `src/network/csagamecoordinator.h/.cpp` — テスト対象（状態遷移）
- `src/services/settingsservice.h/.cpp` — テスト対象（設定永続化）
- `CMakeLists.txt` — テスト登録

## 詳細手順

### Step 1: CSAプロトコルのテスト対象分析

#### CSAクライアントの読み取り
```
src/network/csaclient.h
src/network/csaclient.cpp
```
を読み、以下を特定:
- メッセージパース関数（テスト可能な純粋関数）
- 状態遷移ロジック（接続→ログイン→待機→対局中→終了）
- コマンド生成関数

### Step 2: CSAプロトコルテストの実装（PR-065-a 相当）

```cpp
// tst_csaprotocol.cpp
class Tst_CsaProtocol : public QObject {
    Q_OBJECT
private slots:
    // メッセージパーステスト
    void parseLoginResponse_data();
    void parseLoginResponse();
    void parseMoveMessage_data();
    void parseMoveMessage();
    void parseGameEndMessage_data();
    void parseGameEndMessage();

    // 状態遷移テスト
    void connectionStateTransition();
    void gameStateTransition();

    // コマンド生成テスト
    void generateMoveCommand_data();
    void generateMoveCommand();
};
```

テストケース例:
- ログイン成功/失敗レスポンスのパース
- 手のメッセージ（`+7776FU,T10`）のパース
- 対局終了メッセージのパース
- 不正なメッセージへの対応

### Step 3: SettingsService のテスト対象分析

```
src/services/settingsservice.h
src/services/settingsservice.cpp
```
を読み、保存→復元すべき設定項目を特定。

### Step 4: 設定ラウンドトリップテストの実装（PR-065-b 相当）

```cpp
// tst_settings_roundtrip.cpp
class Tst_SettingsRoundtrip : public QObject {
    Q_OBJECT
private slots:
    void initTestCase();
    void cleanupTestCase();

    // 各設定カテゴリのラウンドトリップ
    void gameSettings();
    void analysisSettings();
    void networkSettings();
    void dialogSizes();
    void fontSizes();
};
```

テスト方針:
- テンポラリディレクトリにINIファイルを作成
- 各種設定値を書き込み
- 読み出して一致を確認
- デフォルト値の確認（設定未保存時）

```cpp
void Tst_SettingsRoundtrip::dialogSizes()
{
    // テンポラリINIファイルを使用
    QTemporaryDir tempDir;
    // 書き込み
    SettingsService::setXxxDialogSize(QSize(800, 600));
    // 読み出し
    QSize restored = SettingsService::xxxDialogSize();
    QCOMPARE(restored, QSize(800, 600));
}
```

### Step 5: CMakeLists.txt にテスト登録
```cmake
add_test_executable(tst_csaprotocol tests/tst_csaprotocol.cpp)
add_test_executable(tst_settings_roundtrip tests/tst_settings_roundtrip.cpp)
```
（実際のマクロ名は既存のテスト定義に合わせる）

### Step 6: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] CSAプロトコルの基本メッセージが自動テストでカバーされている
- [ ] 設定の保存→復元が型ごとに検証されている
- [ ] テスト数が 37 → 39 以上に増加
- [ ] 全テスト Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
cd build && ctest -N | wc -l  # テスト数確認
cd build && ctest --output-on-failure -R csa
cd build && ctest --output-on-failure -R settings
```
