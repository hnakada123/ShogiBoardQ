# Task 26: KPI 再計測と閾値引き下げ（ISSUE-050）

## フェーズ
G: 収束

## 前提条件
- フェーズB〜Fの主要タスクが完了していること
- 特に以下が完了していること:
  - Task 05（ISSUE-011）〜 Task 11（ISSUE-023）: 巨大ファイル分割
  - Task 17〜19（ISSUE-040〜042）: delete 削減
  - Task 21〜24（ISSUE-061〜064）: ダイアログ共通化・SIGNAL/SLOT 排除
  - Task 25（ISSUE-065）: テスト拡充

## 目的
改善後の実測値を取得し、構造KPIテストの上限値を引き下げて、品質ゲートを強化する。

## 対象ファイル
- `tests/tst_structural_kpi.cpp` — KPI閾値の更新
- `docs/dev/code-quality-improvement-proposal-2026-02-27.md` — 追跡KPIの実績更新

## 詳細手順

### Step 1: 全指標の再計測
以下のコマンドで現在値を取得:

```bash
# 1. 総行数
find src -name "*.cpp" -o -name "*.h" | xargs wc -l | tail -1

# 2. 600行超ファイル数
find src -name "*.cpp" -o -name "*.h" | xargs wc -l | awk '$1 > 600' | wc -l

# 3. 1000行超ファイル数
find src -name "*.cpp" -o -name "*.h" | xargs wc -l | awk '$1 > 1000' | wc -l

# 4. delete 件数
grep -rn 'delete ' src --include="*.cpp" | grep -v '//' | grep -v '#include' | wc -l

# 5. connect 総数
grep -rn 'connect(' src --include="*.cpp" | wc -l

# 6. lambda connect 件数
grep -rn 'connect(' src --include="*.cpp" | grep '\[' | wc -l

# 7. 旧式 SIGNAL/SLOT 件数
grep -rn 'SIGNAL(\|SLOT(' src --include="*.cpp" | wc -l

# 8. テスト数
cd build && ctest -N | grep "Test #" | wc -l

# 9. 翻訳未完了数
grep -c 'type="unfinished"' resources/translations/*.ts
```

### Step 2: KPI閾値の引き下げ
`tests/tst_structural_kpi.cpp` の各上限値を「実測値 + 最小マージン」に更新:

```cpp
// 更新前（例）
const int kMaxLargeFiles = 9;      // 旧: 8+1
const int kMaxDeleteCount = 19;     // 旧: 17+2
const int kMaxLambdaConnects = 7;   // 旧: 6+1

// 更新後（実測値に基づく）
const int kMaxLargeFiles = X + 1;   // 実測値 + 1
const int kMaxDeleteCount = Y + 2;  // 実測値 + 2
const int kMaxLambdaConnects = Z + 1; // 実測値 + 1
```

### Step 3: `fileLineLimits()` の例外リスト更新
1000行超から脱出したファイルの例外エントリを削除。
まだ残っているファイルの上限値を実測値 + マージンに更新。

### Step 4: 追跡KPIの実績更新
`docs/dev/code-quality-improvement-proposal-2026-02-27.md` の「追跡KPI」テーブルに実績列を追加。

### Step 5: CI 翻訳閾値の確認
`.github/workflows/ci.yml` の翻訳閾値も必要に応じて引き下げ。

### Step 6: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

## 完了条件
- [ ] 全指標の再計測が完了
- [ ] KPI閾値が実測値に基づいて引き下げられている
- [ ] 目標未達の指標が特定され、次期 Issue に繰り越されている
- [ ] 全テスト Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
cd build && ctest --output-on-failure -R tst_structural_kpi
```
