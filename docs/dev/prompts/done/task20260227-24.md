# Task 24: 旧式 SIGNAL/SLOT マクロ排除（ISSUE-064）

## フェーズ
F: ダイアログ品質・テスト拡充

## 前提条件
- Task 01（ISSUE-001: 構造KPIテスト拡張）が完了していること

## 目的
残存する5箇所の旧式 `SIGNAL()` / `SLOT()` マクロ接続を、メンバ関数ポインタ構文に移行する。

## 現状
3ファイル、5箇所に旧形式の文字列ベース接続が残存:

1. `src/ui/coordinators/positioneditcoordinator.cpp` — `SLOT(finishPositionEditing())` (1箇所)
2. `src/board/positioneditcontroller.cpp` — `SIGNAL(clicked())` / `SLOT()` (2箇所)
3. `src/game/turnsyncbridge.cpp` — `SIGNAL(changed(...))` / `SLOT(onTurnManagerChanged(...))` (2箇所)

## 対象ファイル
- `src/ui/coordinators/positioneditcoordinator.cpp`
- `src/ui/coordinators/positioneditcoordinator.h`（必要に応じて）
- `src/board/positioneditcontroller.cpp`
- `src/board/positioneditcontroller.h`（必要に応じて）
- `src/game/turnsyncbridge.cpp`
- `src/game/turnsyncbridge.h`（必要に応じて）
- `tests/tst_structural_kpi.cpp` — 旧式接続件数の監視追加

## 詳細手順

### Step 1: 各箇所の現状確認と移行方針決定

#### positioneditcoordinator.cpp
1. ファイルを読み、`SLOT(finishPositionEditing())` の使用箇所を確認
2. 接続先のシグナルとスロットの型を確認
3. メンバ関数ポインタ構文に移行:
```cpp
// Before
connect(sender, SIGNAL(someSignal()), receiver, SLOT(finishPositionEditing()));

// After
connect(sender, &SenderClass::someSignal, receiver, &ReceiverClass::finishPositionEditing);
```

#### positioneditcontroller.cpp
1. ファイルを読み、`SIGNAL(clicked())` と `SLOT()` の使用箇所を確認
2. **動的 disconnect/connect パターン**がある場合:
   - `QMetaObject::Connection` を使って接続を管理する方式に変更
   ```cpp
   // ヘッダー
   QMetaObject::Connection m_clickConnection;

   // 接続
   m_clickConnection = connect(button, &QPushButton::clicked, this, &Controller::onClicked);

   // 切断
   disconnect(m_clickConnection);
   ```

#### turnsyncbridge.cpp
1. ファイルを読み、`SIGNAL(changed(...))` と `SLOT(onTurnManagerChanged(...))` の使用箇所を確認
2. シグナル/スロットの引数型を正確に把握
3. メンバ関数ポインタ構文に移行:
```cpp
// Before
connect(m_turnManager, SIGNAL(changed(Player)), this, SLOT(onTurnManagerChanged(Player)));

// After
connect(m_turnManager, &TurnManager::changed, this, &TurnSyncBridge::onTurnManagerChanged);
```

### Step 2: 各ファイルの修正

修正時の注意点:
- **オーバーロードされたシグナル**がある場合は `qOverload<>()` を使用:
  ```cpp
  connect(spinner, qOverload<int>(&QSpinBox::valueChanged), this, &MyClass::onValueChanged);
  ```
- **シグナルの引数型が完全修飾でない場合**は、ヘッダーでの宣言も確認

### Step 3: 構造KPIに旧式接続件数の監視を追加
`tests/tst_structural_kpi.cpp` に旧式マクロの監視テストを追加:

```cpp
void Tst_StructuralKpi::oldStyleConnectionCount()
{
    const int kMaxOldStyleConnections = 0;
    // src/ 配下の .cpp で SIGNAL( または SLOT( の出現数をカウント
    // QVERIFY2(count <= kMaxOldStyleConnections, ...)
}
```

### Step 4: ビルド・テスト
```bash
cmake --build build
cd build && ctest --output-on-failure
```

### Step 5: 旧式マクロの残存確認
```bash
grep -rn 'SIGNAL(' src/ --include="*.cpp" | wc -l
grep -rn 'SLOT(' src/ --include="*.cpp" | wc -l
```

## 完了条件
- [ ] `src/` 内の `SIGNAL()` / `SLOT()` マクロ使用が 0 件
- [ ] 動的 disconnect/connect は `QMetaObject::Connection` 管理に変更
- [ ] 構造KPIに旧式接続の監視が追加されている
- [ ] 全テスト Pass

## 検証コマンド
```bash
cmake --build build
cd build && ctest --output-on-failure
# 旧式マクロの完全排除確認
grep -rn 'SIGNAL(\|SLOT(' src/ --include="*.cpp" | wc -l  # 0 であること
cd build && ctest --output-on-failure -R tst_structural_kpi
```
