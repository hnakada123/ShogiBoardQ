# KIF形式 分岐棋譜の '+' マーク仕様

## 概要

KIF形式の分岐棋譜では、指し手行の末尾に `+` マークを付加して分岐の存在を示す。
この仕様は公式にドキュメント化されておらず、事実上の標準である Kifu for Windows の出力挙動に準拠する。

## '+' マークのルール

**'+' は、そのノードに「次の兄弟」が存在する場合にのみ付加する。**

ツリー構造で言えば、同じ親ノードの子リストにおいて、自分より後ろにまだ出力されていない兄弟変化がある場合に `+` を付ける。
最後の兄弟（それ以降に変化ブロックが出力されない手）には `+` を付けない。

### 具体例

以下の分岐構造を持つ棋譜の場合:

```
root → ▲７六歩 → △３四歩 → ▲２六歩 → △８四歩 → ▲２五歩 → △投了
                            ├→ ▲１六歩 → △９四歩 → ▲４六歩 → △７四歩
                            │                      └→ ▲５六歩 → △５二金 → ▲５五歩
                            └→ ▲７七桂 → △９二香
                                                   └→ ▲１六歩 → △８五歩 → ▲投了
```

#### '+' 判定の結果

| 行 | ノード | 次の兄弟 | '+' |
|---|---|---|---|
| 本譜 ply3 | ▲２六歩 | ▲１六歩, ▲７七桂 | あり |
| 本譜 ply5 | ▲２五歩 | ▲１六歩 | あり |
| 変化：5手 先頭 | ▲１六歩(n4の子) | なし（最後の兄弟） | **なし** |
| 変化：3手 先頭 | ▲１六歩(n2の子) | ▲７七桂 | あり |
| 変化：3手 ply5 | ▲４六歩 | ▲５六歩 | あり |
| 変化：5手 先頭 | ▲５六歩 | なし（最後の兄弟） | **なし** |
| 変化：3手 先頭 | ▲７七桂 | なし（最後の兄弟） | **なし** |

#### 出力例（Kifu for Windows準拠）

```
手数----指手---------消費時間--
   1 ７六歩(77)   ( 0:01/00:00:01)
   2 ３四歩(33)   ( 0:02/00:00:02)
   3 ２六歩(27)   ( 0:02/00:00:03)+
   4 ８四歩(83)   ( 0:01/00:00:03)
   5 ２五歩(26)   ( 0:01/00:00:04)+
   6 投了         ( 0:03/00:00:06)
まで5手で先手の勝ち

変化：5手
   5 １六歩(17)   ( 0:05/00:00:08)
   6 ８五歩(84)   ( 0:04/00:00:07)
   7 投了         ( 0:02/00:00:10)

変化：3手
   3 １六歩(17)   ( 0:00/00:00:01)+
   4 ９四歩(93)   ( 0:00/00:00:02)
   5 ４六歩(47)   ( 0:00/00:00:01)+
   6 ７四歩(73)   ( 0:00/00:00:02)

変化：5手
   5 ５六歩(57)   ( 0:00/00:00:01)
   6 ５二金(61)   ( 0:00/00:00:02)
   7 ５五歩(56)   ( 0:00/00:00:01)

変化：3手
   3 ７七桂(89)   ( 0:00/00:00:01)
   4 ９二香(91)   ( 0:00/00:00:02)
```

## 他ソフトウェアの挙動

| ソフトウェア | '+' の付け方 |
|---|---|
| Kifu for Windows | 後続の兄弟変化がある手のみ付加 |
| ShogiHome (electron-shogi) | Kifu for Windowsに準拠 |
| 将棋所 (Shogidokoro) | '+' を一切付けない |
| 将棋GUI (ShogiGUI) | '+' を一切付けない |

'+' を付けないソフトウェアもあるが、付ける場合は Kifu for Windows のルールに従うのが事実上の標準。

## 実装

`src/kifu/gamerecordmodel.cpp` の `hasNextSibling()` 関数で統一的に判定:

```cpp
static bool hasNextSibling(KifuBranchNode* node)
{
    if (node == nullptr || node->parent() == nullptr) return false;
    const QVector<KifuBranchNode*>& siblings = node->parent()->children();
    const auto myIndex = siblings.indexOf(node);
    return myIndex >= 0 && myIndex < siblings.size() - 1;
}
```

この関数は本譜・変化の区別なく、全ての指し手行の `+` 判定に使用する。

## 参考資料

- [棋譜ファイル KIF 形式（柿木公式）](http://kakinoki.o.oo7.jp/kif_format.html) — 分岐仕様の記載なし
- [将棋の棋譜や局面のフォーマット（Qiita）](https://qiita.com/sunfish-shogi/items/964e139ef3bfd8f738d4) — 「分岐の仕様はドキュメント化されていない」と明記
- [sunfish-shogi/tsshogi](https://github.com/sunfish-shogi/tsshogi) — ShogiHome の KIF 入出力実装。`node.branch` (次の兄弟) の存在で `+` を判定
