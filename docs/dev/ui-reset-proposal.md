# UI コンポーネント初期化リセット提案

## 背景

以下の操作を行った際、各UIコンポーネントが初期状態にリセットされるべきだが、現状では一部が不完全である。

### 対象操作

| 略称 | 操作 |
|---|---|
| **Op1** | 「対局」→「対局」で「開始局面」を「現在の局面」以外に設定して対局開始 |
| **Op2** | 「ファイル」→「開く」または「編集」→「棋譜貼り付け」で棋譜を取り込み |
| **Op3** | 「ファイル」→「新規」でGUI起動時の局面（平手）に戻す |

### 対象コンポーネント

棋譜、対局情報、思考、検討、USI通信ログ、CSA通信ログ、棋譜コメント、分岐ツリー、評価値グラフ、棋譜解析、定跡

## 現状のクリア状況

| コンポーネント | Op1: 対局開始 | Op2: 棋譜読込 | Op3: 新規 |
|---|---|---|---|
| **棋譜** | CLEARED | REPLACED | CLEARED |
| **対局情報** | REPLACED | REPLACED | 未クリア |
| **思考** | 一部クリア [※1] | 未クリア | 一部クリア [※1] |
| **検討** | 未クリア | 未クリア | 未クリア |
| **USI通信ログ** | モデルのみ [※2] | 未クリア | モデルのみ [※2] |
| **CSA通信ログ** | 未クリア | 未クリア | 未クリア |
| **棋譜コメント** | CLEARED | 未クリア [※3] | CLEARED |
| **分岐ツリー** | CLEARED | REPLACED | 一部クリア [※4] |
| **評価値グラフ** | CLEARED | 未クリア | CLEARED |
| **棋譜解析** | 未クリア | 未クリア | 未クリア |
| **定跡** | 表示更新 [※5] | 表示更新 [※5] | 未更新 |

### 注記

- **※1**: エンジン情報フィールド（名前・探索深さ・NPS等）はクリアされるが、思考結果テーブル（`m_view1`/`m_view2`）はクリアされない
- **※2**: `UsiCommLogModel` のプロパティはクリアされるが、表示用の `QPlainTextEdit` は蓄積されたまま
- **※3**: 読み込んだ棋譜のコメントは `m_commentsByRow` に格納されるが、前の棋譜のコメント表示は明示的にクリアされない
- **※4**: 分岐リストモデルはクリアされるが、`resetBranchTreeForNewGame()` は呼ばれない
- **※5**: 定跡データベース（`m_josekiData`）はユーザーデータなのでクリア不要。表示テーブルのみ新局面に合わせて更新される

## あるべき姿

| コンポーネント | Op1: 対局開始 | Op2: 棋譜読込 | Op3: 新規 |
|---|---|---|---|
| **棋譜** | CLEAR | REPLACE | CLEAR |
| **対局情報** | REPLACE | REPLACE | CLEAR |
| **思考** | CLEAR | CLEAR | CLEAR |
| **検討** | CLEAR | CLEAR | CLEAR |
| **USI通信ログ** | CLEAR（表示含む） | CLEAR | CLEAR（表示含む） |
| **CSA通信ログ** | CLEAR | CLEAR | CLEAR |
| **棋譜コメント** | CLEAR | CLEAR→REPLACE | CLEAR |
| **分岐ツリー** | CLEAR | REPLACE | CLEAR（完全リセット） |
| **評価値グラフ** | CLEAR | CLEAR | CLEAR |
| **棋譜解析** | CLEAR | CLEAR | CLEAR |
| **定跡** | 表示更新 | 表示更新 | 表示更新 |

## 差分（要修正箇所）

現状とあるべき姿の差分を操作別にまとめる。

### Op1: 対局開始（非現在局面）で不足しているリセット

| コンポーネント | 現状 | 修正内容 |
|---|---|---|
| 思考 | エンジン情報のみクリア | 思考結果テーブルもクリア |
| 検討 | 未クリア | クリアする |
| USI通信ログ | モデルのみクリア | QPlainTextEdit もクリア |
| CSA通信ログ | 未クリア | クリアする |
| 棋譜解析 | 未クリア | クリアする |

### Op2: 棋譜読み込み/貼り付けで不足しているリセット

| コンポーネント | 現状 | 修正内容 |
|---|---|---|
| 思考 | 未クリア | クリアする |
| 検討 | 未クリア | クリアする |
| USI通信ログ | 未クリア | クリアする |
| CSA通信ログ | 未クリア | クリアする |
| 棋譜コメント | 未クリア | 読込前にクリアする |
| 評価値グラフ | 未クリア | クリアする |
| 棋譜解析 | 未クリア | クリアする |

### Op3: ファイル→新規で不足しているリセット

| コンポーネント | 現状 | 修正内容 |
|---|---|---|
| 対局情報 | 未クリア | クリアする |
| 思考 | エンジン情報のみクリア | 思考結果テーブルもクリア |
| 検討 | 未クリア | クリアする |
| USI通信ログ | モデルのみクリア | QPlainTextEdit もクリア |
| CSA通信ログ | 未クリア | クリアする |
| 分岐ツリー | 一部クリア | `resetBranchTreeForNewGame()` で完全リセット |
| 棋譜解析 | 未クリア | クリアする |
| 定跡 | 未更新 | `updateJosekiWindow()` で表示更新 |

## 関連ソースファイル

| ファイル | 役割 |
|---|---|
| `src/game/prestartcleanuphandler.cpp` | Op1・Op3 で呼ばれるクリーンアップ処理 |
| `src/game/gamestartcoordinator.cpp` | 対局開始フロー |
| `src/kifu/kifuloadcoordinator.cpp` | 棋譜読み込みフロー |
| `src/app/mainwindow.cpp` | `resetToInitialState()`, `updateJosekiWindow()` 等 |
| `src/ui/wiring/uiactionswiring.cpp` | 「新規」アクションの接続 |
| `src/dialogs/josekiwindow.cpp` | 定跡ウィンドウ |
| `src/ui/wiring/josekiwindowwiring.cpp` | 定跡ウィンドウの接続 |
